## /etc/mysql/mariadb.conf.d/50-server.cnf
## Template. Embedded in mariadb_cluster_controller.sh script
[mariadbd]

#################################################################
# REPLICATION / BINLOG (tune durability vs perf)


## PRIMARY
server-id                     = 1
binlog_format                 = ROW
binlog_row_image              = FULL
expire_logs_days              = 10
sync_binlog                   = 0                   # perf; raise to 1 if you need crash-safe binlog
gtid_strict_mode              = ON
innodb_flush_log_at_trx_commit= 2                   # 1 = safest; 2 = faster



## Replica
# server_id                       = 2
#read_only                       = ON
#skip_slave_start                = ON         # start manually first time
#log_slave_updates               = ON         # good for promotion later (keeps binlog chain)
# GTID
#gtid_strict_mode                = ON
# If you set a non-zero domain on primary, match it here:
# gtid_domain_id                = 0

# Crash-safe relay logs
#relay_log_recovery              = ON

##################################################################


# GENERAL
user                          = mysql
bind-address                  = 0.0.0.0          # tighten; open via proxy/firewall if needed
port                          = 3306
skip-name-resolve
max_connections               = 1500
wait_timeout                  = 900
interactive_timeout           = 900
max_allowed_packet            = 256M
tmpdir                        = /tmp
performance_schema            = ON
socket                        = /var/run/mysqld/mysqld.sock

# CHARACTER SET
character-set-server          = utf8mb4
collation-server              = utf8mb4_general_ci  # keep unless you need stricter Unicode sort order

# DATA & LOGS
basedir                       = /usr
datadir                       = /var/lib/mysql/data
pid-file                      = /run/mysqld/mysqld.pid
log-error                     = /var/lib/mysql/log/error.log
slow_query_log_file           = /var/lib/mysql/log/slow-query.log
general_log_file              = /var/lib/mysql/log/mariadb.log
relay_log                     = /var/lib/mysql/log/relay-bin
log_bin                       = /var/lib/mysql/log/binlog
innodb_log_group_home_dir     = /var/lib/mysql/log
expire_logs_days              = 7

# SLOW LOGGING  (reduce overhead vs your current settings)
slow_query_log                = ON
log_queries_not_using_indexes = OFF                 # too noisy/costly at scale
long_query_time               = 0.05                # was 0.001; sample instead:
log_slow_rate_limit           = 10                  # log ~1 in 10 slow queries
log_slow_verbosity            = query_plan,innodb  # "ALL" is heavy

# CONNECTION / THREAD POOL
thread_handling               = pool-of-threads
thread_pool_size              = 8                  # start â‰ˆ num physical cores; tune by test
thread_pool_stall_limit       = 60                  # use sane default; 10 can cause churn
thread_pool_max_threads       = 1000
thread_cache_size             = 256

# INNODB ENGINE
default-storage-engine        = InnoDB
innodb_file_per_table         = 1
innodb_flush_method           = O_DIRECT            # avoids double caching; ZFS may ignore, harmless
innodb_doublewrite            = 0                   # OK on ZFS (CoW + checksums)
innodb_use_native_aio         = 0
innodb_use_atomic_writes      = 0
innodb_log_file_size          = 4096M               # total redo = 8G; good for write bursts
innodb_log_files_in_group     = 2
innodb_log_buffer_size        = 64M
innodb_buffer_pool_size       = 16G                 # raise (you had 32G); fits your 128G box plan
innodb_buffer_pool_instances  = 8
innodb_io_capacity            = 20000
innodb_io_capacity_max        = 30000
innodb_flush_neighbors        = 0
innodb_checksum_algorithm     = crc32
innodb_compression_algorithm  = none
innodb_compression_level      =
innodb_autoinc_lock_mode      = 2
innodb_stats_on_metadata      = OFF
innodb_purge_threads          = 4
innodb_lru_scan_depth         = 4096                # (replace non-standard lru_flush_size)
innodb_log_write_ahead_size   = 16k
innodb_page_size              = 16384


# TEMP / PER-CONNECTION BUFFERS (safer caps)
tmp_table_size                = 256M                # was 512M; reduce bloat risk
max_heap_table_size           = 256M
join_buffer_size              = 4M                  # was 24M; large per-conn buffers = RAM spikes
sort_buffer_size              = 4M

# TABLE / FILE CACHES
table_open_cache              = 8000
table_definition_cache        = 8000
open_files_limit              = 200000

# QUERY CACHE OFF (good)
query_cache_type              = 0
query_cache_size              = 0

# MONITORING (keep moderate)
plugin_load_add               = query_response_time
query-response-time-stats     = 1
